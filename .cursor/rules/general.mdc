---
alwaysApply: true
---
# HARD CONSTRAINTS (MUST FOLLOW)

## Package Management & Tooling

### Backend (Python)
- **MUST** use `uv` Python package manager. All commands **MUST** be prefixed with `uv run`.
    - Add scripts to `pyproject.toml` that can run via `uv run …`
    - Both `uv sync` and `uv run` require `required_permissions: ["all"]` because they access `~/.cache/uv/` outside the workspace
- **MUST** target Python 3.14+ only, **NO** backward compatibility
- **MUST** use `ruff` as a linter and `mypy` for type checking
- **MUST** use type hints for all Python code. Deferred (lazy) evaluation of annotations is the default.
- **NEVER** use `from __future__ import annotations` - it's unnecessary in Python 3.14+

### Available Scripts (Backend)
- `uv run codegen` - Regenerate Shopify GraphQL client (loads `.env` automatically)
- `uv run alembic upgrade head` - Run database migrations (requires `DATABASE_URL` in `.env`)
- `uv run alembic revision --autogenerate -m "description"` - Create new migration

### Frontend (TypeScript/React)
- **MUST** use `npm` as package manager
- **MUST** use TypeScript strict mode
- **MUST** use ESLint + Prettier for linting/formatting
- **MUST** use Vite as build tool

## Framework & Library Constraints

### Backend
- **Web framework:** **FastAPI** (ASGI) **ONLY**. **NEVER** use Flask, Django, or any other framework.
- **Database ORM:** **SQLModel** for all database models and queries.
- **HTTP client:** `httpx` (async) **ONLY**. **NEVER** add or use `requests`.
- **Background jobs:** **Dramatiq** + **Redis** for long-running work.
    - `ingest_order` task - fetches order from Shopify, creates LineItem/Image records
    - `download_order_images` task - downloads images in parallel with `asyncio.gather`
    - Use `tenacity` for per-operation retries with exponential backoff
- **Real-time:** Publish events to **Mercure** hub for SSE push to frontend.
- **Shopify API:** Use `ariadne-codegen` generated typed client in `app/services/shopify_client/`.
    - GraphQL queries are defined in `app/graphql/queries/`
    - Run `uv run codegen` after modifying queries to regenerate the client
    - Generated code is excluded from ruff and mypy checks
- **Utilities:** Common helpers in `app/utils/`:
    - `datetime_utils.py` - timezone conversions (`to_api_timezone`)
    - `shopify_helpers.py` - `build_customer_name()`, `normalize_order_number()`

### Frontend
- **Framework:** React 18+ with TypeScript
- **Styling:** Tailwind CSS + shadcn/ui components
- **State Management:** TanStack Query for server state (API caching, auto-refetching)
- **Routing:** React Router v6+
- **Real-time:** Native EventSource API for Mercure SSE subscriptions

## Design Principles
- **Async-first:** All I/O paths **MUST** be async. **NEVER** block in request handlers.
- **Parallel operations:** Use `asyncio.gather` for independent async operations (e.g., parallel image downloads, parallel HTTP requests)
    - **Note:** SQLAlchemy async sessions do NOT support concurrent queries on the same session
- Offload long work to Dramatiq workers (image downloads, PDF generation)
- Backend modules **MUST** belong under `backend/app/` in a fitting subpackage
- Frontend modules **MUST** belong under `frontend/src/` in a fitting directory
- **NEVER** hardcode tokens/keys. Read secrets from `.env`.
    - Use `pydantic-settings` for backend configuration
    - **MUST** add new secret variables to `.env.example`

## Environment Setup
- Copy `.env.example` to `.env` and fill in the values
- **Local development** (outside Docker):
    - `DATABASE_URL` must point to `localhost:5439` (docker-compose exposes postgres on port 5439 to avoid system postgres conflicts)
    - Required for running `uv run alembic` commands locally
- **Inside Docker containers**: `DATABASE_URL` is set automatically via docker-compose

## Webhook Handling
- **MUST** verify Shopify HMAC signature (`X-Shopify-Hmac-Sha256`) before processing
- **MUST** return `200 OK` immediately to Shopify before starting background processing
- **MUST** implement idempotency - duplicate webhooks should not corrupt data (use `shopify_id` as unique key)

## Real-time Updates (Ping-to-Refetch Pattern)
- **DO NOT** send full data payloads via SSE
- **MUST** emit Mercure events on **every** state change:
    - New order created (webhook, manual fetch) → `publish_order_list_update()`
    - Order status changed → `publish_order_update(order_number)`
    - Images downloaded/updated → `publish_order_update(order_number)`
    - Any data modification visible to users → appropriate Mercure publish
- **Pattern:**
    1. Backend updates PostgreSQL
    2. Backend posts lightweight ping to Mercure topic:
        - List updates: `{"type": "list_update"}` to `orders` topic
        - Order updates: `{"type": "order_update", "order_number": "1270"}` to `orders` and `orders/{order_number}` topics
    3. Frontend receives ping via SSE (hooks in `frontend/src/hooks/`)
    4. Frontend invalidates TanStack Query cache → triggers refetch from API
- **Frontend hooks:**
    - `useOrderListEvents()` - subscribes to `orders` topic for list view
    - `useOrderEvents(orderNumber)` - subscribes to `orders/{orderNumber}` topic for detail view

## Quality & Testing (MANDATORY)

### Backend
- **MUST** run `uv run ruff check app/` and `uv run mypy app/` before considering work complete
- Fix all ruff and mypy errors before committing
- Use `uv run ruff check --fix app/` to auto-fix ruff issues

### Frontend
- **MUST** run `npm run check` (or individually: `npm run lint`, `npm run typecheck`, `npm run format:check`) before considering work complete
- Fix all TypeScript and ESLint errors before committing
- Use `npm run lint:fix` to auto-fix ESLint issues
- Use `npm run format` to auto-format code with Prettier

## Error Handling
- If image download fails, update DB status to `error` and expose a "Retry" button in the UI
- Log errors with structured logging (use `structlog` for backend)
- **MUST** handle Shopify API rate limits gracefully (implement retry with backoff)

## Order Status Flow
| Status | Description |
|--------|-------------|
| `pending` | Webhook received, waiting for processing |
| `processing` | `ingest_order` task running (fetching from Shopify, creating records) |
| `downloading` | `download_order_images` task running (parallel image downloads) |
| `ready_for_review` | All images downloaded, ready for admin review |
| `error` | Something failed (show Retry button) |

### Task Flow
```
webhook/API → ingest_order (PROCESSING) → download_order_images (DOWNLOADING) → READY_FOR_REVIEW
```
- `ingest_order`: Fetches Shopify data, creates LineItem/Image records, dispatches download task
- `download_order_images`: Downloads all images in parallel with retries, updates status
